<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wynzio - Remote Viewer</title>
    <link rel="stylesheet" href="../css/main.css">
    <link rel="stylesheet" href="../css/remote-viewer.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="shortcut icon" href="../assets/favicon.ico" type="image/x-icon">
    <script src="../js/config.js"></script>
    <script src="../js/utils.js"></script>
    <script src="../js/auth.js"></script>
    <script src="../js/app.js"></script>
    <script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script>
    <script src="../js/webrtc-viewer.js"></script>
</head>
<body>
    <div class="remote-viewer-container">
        <!-- Header -->
        <div class="viewer-header">
            <div class="device-info">
                <button class="back-button" id="back-button">
                    <i class="fas fa-arrow-left"></i>
                </button>
                <h2 id="device-name">Connecting to device...</h2>
                <span id="device-status" class="status-badge offline">Offline</span>
            </div>
            <div class="viewer-controls">
                <button class="control-button" id="control-toggle" title="Toggle Remote Control">
                    <i class="fas fa-mouse-pointer"></i>
                </button>
                <button class="control-button" id="fullscreen-button" title="Fullscreen">
                    <i class="fas fa-expand"></i>
                </button>
                <button class="control-button" id="refresh-button" title="Refresh Connection">
                    <i class="fas fa-sync-alt"></i>
                </button>
                <button class="control-button danger" id="disconnect-button" title="Disconnect">
                    <i class="fas fa-power-off"></i>
                </button>
            </div>
        </div>
        
        <!-- Main Screen Viewer -->
        <div class="viewer-content">
            <div class="screen-container" id="screen-container">
                <!-- Screen will be rendered here -->
                <div id="loading-indicator" class="loading-indicator">
                    <div class="loader"></div>
                    <p>Connecting to device...</p>
                </div>
                <div id="screen-view" class="screen-view">
                    <!-- Video will be appended here by WebRTC -->
                </div>
                <div id="connection-error" class="connection-error hidden">
                    <i class="fas fa-exclamation-triangle"></i>
                    <h3>Connection Error</h3>
                    <p id="error-message">Unable to connect to the device.</p>
                    <button id="retry-button" class="btn btn-primary">Retry Connection</button>
                </div>
            </div>
        </div>
        
        <!-- Footer -->
        <div class="viewer-footer">
            <div class="connection-info">
                <span id="connection-status">Disconnected</span>
                <span id="connection-quality" class="quality-indicator">Quality: N/A</span>
            </div>
            <div class="session-info">
                <span id="session-time">00:00:00</span>
                <span id="resolution-info">Resolution: N/A</span>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                // Protect page - redirect to login if not authenticated
                const isAuthenticated = await Auth.protectPage();
                
                if (!isAuthenticated) {
                    // If not authenticated, stop execution
                    return;
                }
                
                // Get device ID from URL
                const urlParams = new URLSearchParams(window.location.search);
                const deviceId = urlParams.get('id');
                
                if (!deviceId) {
                    showError('No device ID specified');
                    return;
                }
                
                // Initialize viewer
                initViewer(deviceId);
            } catch (error) {
                console.error('Viewer initialization error:', error);
                showError(error.message);
            }
        });
        
        let socket = null;
        let rtcClient = null;
        let sessionStartTime = null;
        let sessionTimer = null;
        let controlEnabled = true;
        
        /**
         * Initialize the remote viewer
         * @param {string} deviceId - Device ID to connect to
         */
        async function initViewer(deviceId) {
            try {
                // Set up UI event handlers
                document.getElementById('back-button').addEventListener('click', function() {
                    window.location.href = '/dashboard';
                });
                
                document.getElementById('control-toggle').addEventListener('click', toggleControl);
                document.getElementById('fullscreen-button').addEventListener('click', toggleFullscreen);
                document.getElementById('refresh-button').addEventListener('click', refreshConnection);
                document.getElementById('disconnect-button').addEventListener('click', disconnectAndReturn);
                document.getElementById('retry-button').addEventListener('click', function() {
                    connectToDevice(deviceId);
                });
                
                // Fetch device information
                await fetchDeviceInfo(deviceId);
                
                // Connect to device
                await connectToDevice(deviceId);
            } catch (error) {
                console.error('Error initializing viewer:', error);
                showError(error.message);
            }
        }
        
        /**
         * Fetch device information from the API
         * @param {string} deviceId - Device ID
         */
        async function fetchDeviceInfo(deviceId) {
            try {
                const response = await fetch(`/api/devices/${deviceId}`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${Auth.getToken()}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    throw new Error('Failed to fetch device information');
                }
                
                const data = await response.json();
                
                if (!data.success) {
                    throw new Error(data.message || 'Failed to fetch device information');
                }
                
                // Update UI with device information
                document.getElementById('device-name').textContent = data.device.systemName;
                updateDeviceStatus(data.device.status);
            } catch (error) {
                console.error('Error fetching device information:', error);
                throw error;
            }
        }
        
        /**
         * Update device status indicator
         * @param {string} status - Device status
         */
        function updateDeviceStatus(status) {
            const statusElement = document.getElementById('device-status');
            
            // Remove all status classes
            statusElement.classList.remove('online', 'offline', 'idle');
            
            // Add appropriate class
            statusElement.classList.add(status);
            
            // Update text
            statusElement.textContent = status.charAt(0).toUpperCase() + status.slice(1);
        }
        
        /**
         * Connect to device via WebRTC
         * @param {string} deviceId - Device ID
         */
        async function connectToDevice(deviceId) {
            try {
                // Show loading indicator
                document.getElementById('loading-indicator').classList.remove('hidden');
                document.getElementById('connection-error').classList.add('hidden');
                document.getElementById('screen-view').innerHTML = '';
                
                // Update connection status
                document.getElementById('connection-status').textContent = 'Connecting...';
                
                // Disconnect existing connection if any
                if (rtcClient) {
                    rtcClient.disconnect();
                    rtcClient = null;
                }
                
                if (socket) {
                    socket.disconnect();
                    socket = null;
                }
                
                // Clear session timer
                if (sessionTimer) {
                    clearInterval(sessionTimer);
                    sessionTimer = null;
                }
                
                // Connect to Socket.IO server
                socket = io('', {
                    query: {
                        type: 'dashboard',
                        clientId: 'web-' + Date.now()
                    },
                    auth: {
                        token: Auth.getToken()
                    }
                });
                
                // Wait for socket connection
                await new Promise((resolve, reject) => {
                    socket.on('connect', resolve);
                    socket.on('connect_error', reject);
                    socket.on('error', reject);
                    
                    // Set timeout for connection
                    const timeout = setTimeout(() => {
                        reject(new Error('Connection timeout'));
                    }, 10000);
                    
                    // Clear timeout on connect
                    socket.on('connect', () => clearTimeout(timeout));
                });
                
                // Initialize WebRTC client
                rtcClient = WynzioWebRTC.initialize({
                    socket: socket,
                    viewerElement: 'screen-view',
                    deviceId: deviceId,
                    enableControls: controlEnabled,
                    onConnecting: () => {
                        document.getElementById('connection-status').textContent = 'Establishing WebRTC connection...';
                    },
                    onConnected: () => {
                        // Hide loading indicator
                        document.getElementById('loading-indicator').classList.add('hidden');
                        
                        // Update connection status
                        document.getElementById('connection-status').textContent = 'Connected';
                        
                        // Start session timer
                        startSessionTimer();
                        
                        // Update control button state
                        updateControlButtonState();
                    },
                    onDisconnected: (reason) => {
                        document.getElementById('connection-status').textContent = 'Disconnected: ' + reason;
                        
                        // Stop session timer
                        if (sessionTimer) {
                            clearInterval(sessionTimer);
                            sessionTimer = null;
                        }
                        
                        // Show connection error
                        showError('Connection closed: ' + reason);
                    },
                    onError: (error) => {
                        console.error('WebRTC error:', error);
                        showError(error);
                    }
                });
                
                // Send connection request to server
                const response = await fetch(`/api/devices/${deviceId}/connect`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${Auth.getToken()}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    throw new Error('Failed to initiate connection');
                }
                
                const data = await response.json();
                
                if (!data.success) {
                    throw new Error(data.message || 'Failed to initiate connection');
                }
                
                // Connect WebRTC client
                await rtcClient.connect(deviceId);
                
                // Request device status update
                socket.emit('device-status-request', {
                    deviceId: deviceId
                });
            } catch (error) {
                console.error('Error connecting to device:', error);
                showError(error.message);
            }
        }
        
        /**
         * Show connection error
         * @param {string} message - Error message
         */
        function showError(message) {
            // Hide loading indicator
            document.getElementById('loading-indicator').classList.add('hidden');
            
            // Show error message
            const errorElement = document.getElementById('connection-error');
            errorElement.classList.remove('hidden');
            
            // Update error message
            document.getElementById('error-message').textContent = message;
        }
        
        /**
         * Start session timer
         */
        function startSessionTimer() {
            // Set session start time
            sessionStartTime = new Date();
            
            // Update timer display
            updateSessionTime();
            
            // Start timer interval
            sessionTimer = setInterval(updateSessionTime, 1000);
        }
        
        /**
         * Update session time display
         */
        function updateSessionTime() {
            if (!sessionStartTime) return;
            
            const now = new Date();
            const diff = now - sessionStartTime;
            
            // Calculate hours, minutes, seconds
            const hours = Math.floor(diff / 3600000);
            const minutes = Math.floor((diff % 3600000) / 60000);
            const seconds = Math.floor((diff % 60000) / 1000);
            
            // Format time string
            const timeString = [
                hours.toString().padStart(2, '0'),
                minutes.toString().padStart(2, '0'),
                seconds.toString().padStart(2, '0')
            ].join(':');
            
            // Update display
            document.getElementById('session-time').textContent = timeString;
        }
        
        /**
         * Toggle remote control
         */
        function toggleControl() {
            if (!rtcClient) return;
            
            controlEnabled = !controlEnabled;
            
            if (controlEnabled) {
                rtcClient.enableControls();
            } else {
                rtcClient.disableControls();
            }
            
            // Update button state
            updateControlButtonState();
        }
        
        /**
         * Update control button state
         */
        function updateControlButtonState() {
            const button = document.getElementById('control-toggle');
            
            if (controlEnabled) {
                button.classList.add('active');
                button.title = 'Disable Remote Control';
            } else {
                button.classList.remove('active');
                button.title = 'Enable Remote Control';
            }
        }
        
        /**
         * Toggle fullscreen mode
         */
        function toggleFullscreen() {
            const container = document.getElementById('screen-container');
            
            if (!document.fullscreenElement) {
                // Enter fullscreen
                if (container.requestFullscreen) {
                    container.requestFullscreen();
                } else if (container.webkitRequestFullscreen) {
                    container.webkitRequestFullscreen();
                } else if (container.msRequestFullscreen) {
                    container.msRequestFullscreen();
                }
                
                // Update button
                document.getElementById('fullscreen-button').innerHTML = '<i class="fas fa-compress"></i>';
                document.getElementById('fullscreen-button').title = 'Exit Fullscreen';
            } else {
                // Exit fullscreen
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                } else if (document.webkitExitFullscreen) {
                    document.webkitExitFullscreen();
                } else if (document.msExitFullscreen) {
                    document.msExitFullscreen();
                }
                
                // Update button
                document.getElementById('fullscreen-button').innerHTML = '<i class="fas fa-expand"></i>';
                document.getElementById('fullscreen-button').title = 'Fullscreen';
            }
        }
        
        /**
         * Refresh connection
         */
        function refreshConnection() {
            const deviceId = new URLSearchParams(window.location.search).get('id');
            if (deviceId) {
                connectToDevice(deviceId);
            }
        }
        
        /**
         * Disconnect and return to dashboard
         */
        function disconnectAndReturn() {
            // Disconnect WebRTC
            if (rtcClient) {
                rtcClient.disconnect();
                rtcClient = null;
            }
            
            // Disconnect socket
            if (socket) {
                socket.disconnect();
                socket = null;
            }
            
            // Clear session timer
            if (sessionTimer) {
                clearInterval(sessionTimer);
                sessionTimer = null;
            }
            
            // Return to dashboard
            window.location.href = '/dashboard';
        }
        
        // Handle page unload
        window.addEventListener('beforeunload', function() {
            // Disconnect WebRTC
            if (rtcClient) {
                rtcClient.disconnect();
            }
            
            // Disconnect socket
            if (socket) {
                socket.disconnect();
            }
        });
    </script>
</body>
</html>